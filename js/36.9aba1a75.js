(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[36],{"80ab":function(t,e,a){"use strict";a.r(e);var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("q-page",{staticClass:"flex flex-center"},[a("div",{staticClass:"auth-form"},[a("h4",[t._v("登录")]),a("q-form",{staticClass:"q-gutter-md",on:{submit:t.onSubmit}},[a("q-input",{attrs:{filled:"",label:"用户名/邮箱","lazy-rules":"",rules:[function(t){return t&&t.length>0||"请输入用户名或邮箱"}]},model:{value:t.username,callback:function(e){t.username=e},expression:"username"}}),a("q-input",{attrs:{filled:"",type:"password",label:"密码","lazy-rules":"",rules:[function(t){return t&&t.length>0||"请输入密码"}]},model:{value:t.password,callback:function(e){t.password=e},expression:"password"}}),t.useCaptcha?a("q-input",{ref:"captcha",attrs:{filled:"",label:t.hasGenCapt?"验证码":"点击输入框显示验证码","lazy-rules":"",rules:[function(t){return t&&t.length>0||"请输入验证码"}]},on:{click:t.showCaptcha,focus:function(e){t.captchaInputing=!0},blur:function(e){t.captchaInputing=!1}},model:{value:t.captcha,callback:function(e){t.captcha=e},expression:"captcha"}},[a("q-popup-proxy",{ref:"captchaShow",attrs:{"no-parent-event":""},on:{show:t.captchaInputFocus}},[a("q-banner",{attrs:{dense:"",dark:""}},[t.captchaImg?a("img",{staticClass:"cursor-pointer",attrs:{src:t.captchaImg,alt:"点击刷新验证码",title:"点击刷新验证码"},on:{click:t.getCaptcha}}):a("span",[t._v("验证码加载中...")])])],1)],1):t._e(),t.enableTelegramLogin?a("vue-telegram-login",{attrs:{mode:"callback","telegram-login":t.tgBotName},on:{callback:t.onTelegramLogin}}):t._e(),t.needV2?a("vue-recaptcha",{attrs:{sitekey:t.v2_key,loadRecaptchaScript:!0,recaptchaHost:"www.recaptcha.net"},on:{verify:t.onCaptchaVerify}}):t._e(),a("recaptcha-js-v3"),a("div",[a("q-btn",{attrs:{label:"登录",type:"submit",color:"primary",loading:t.doing,disable:t.doing}}),t.allowRegister?a("q-btn",{staticClass:"q-ml-sm",attrs:{label:"去注册",color:"primary",flat:"",to:"/register"}}):t._e(),a("q-btn",{staticClass:"q-ml-sm",attrs:{label:"忘记密码",color:"primary",flat:"",to:"/password_reset_request"}})],1),t.loginIssue?a("div",{staticClass:"text-center"},[a("q-btn",{attrs:{flat:"",color:"primary"},on:{click:function(e){t.useCaptcha=!0}}},[t._v("无法登录？点我切换登录模式")])],1):t._e()],1)],1)])},c=[],s=(a("551c"),a("06db"),a("097d"),a("d226")),i=a("e096"),o={data:function(){return{username:"",password:"",needV2:!1,recaptcha_v2:null,doing:!1,allowRegister:!1,loginIssue:!1,timeout:null,useCaptcha:!1,captcha:null,captchaImg:null,hasGenCapt:!1,captchaInputing:!1}},created:function(){var t=this;this.$axios.get("/cfg/allowRegister").then((function(e){t.allowRegister=e.data.result||!1}))},destroyed:function(){clearTimeout(this.timeout)},methods:{onCaptchaVerify:function(t){this.recaptcha_v2=t},onSubmit:function(){var t=this;this.doing=!0,this.useCaptcha?this.login(!0):grecaptcha.ready((function(){grecaptcha.execute(t.v3_key,{action:"login"}).then((function(e){t.login(!1,e)}))}))},login:function(t,e){var a=this,n={user:this.username,pass:this.password};t?n.captcha=this.captcha:(n["recaptcha-v3-token"]=e,n["g-recaptcha-response"]=this.recaptcha_v2),this.$axios.post("/user/auth/login",n).then((function(t){t.data.success?(a.$store.dispatch("auth/login",t.data.token),a.$store.dispatch("auth/expire",t.data.expire),a.$router.push(a.$route.query.redirect||"overview"),a.$nextTick((function(){a.removeCaptchaBadge()}))):t.data?(t.data.needV2&&(a.needV2=!0),t.data.refreshCaptcha&&a.getCaptcha(),a.$q.notify({position:"top",message:t.data.msg})):a.$q.notify({position:"top",message:"未知错误，请重试"}),a.doing=!1})).catch((function(){a.doing=!1}))},onTelegramLogin:function(t){var e=this;this.$q.loading.show({delay:400}),this.$axios.post("/user/auth/telegram",t).then((function(t){e.$store.dispatch("auth/login",t.data.token),e.$store.dispatch("auth/expire",t.data.expire),e.$router.push(e.$route.query.redirect||"overview"),e.$nextTick((function(){e.removeCaptchaBadge()}))})).catch((function(t){switch(t.response.status){case 403:case 404:case 419:e.$q.notify(t.response.data.message);break;default:e.$q.notify("未知错误")}})).finally((function(){e.$q.loading.hide()}))},removeCaptchaBadge:function(){document.querySelector(".grecaptcha-badge").remove()},showCaptcha:function(){var t=this;this.hasGenCapt||(this.getCaptcha(),this.hasGenCapt=!0),this.$nextTick((function(){t.$refs.captchaShow.show()}))},getCaptcha:function(){var t=this;this.$axios.get("/user/auth/captcha").then((function(e){t.captchaImg=e.data}))},captchaInputFocus:function(){var t=this;this.$nextTick((function(){t.$refs.captcha.focus()}))}},components:{vueTelegramLogin:s["vueTelegramLogin"],"recaptcha-js-v3":{render:function(t){return t("script",{attrs:{type:"text/javascript",src:"https://www.recaptcha.net/recaptcha/api.js?render="+window.appConfig.recaptcha.v3_sitekey}})}},VueRecaptcha:i["a"]},computed:{tgBotName:function(){return window.appConfig.telegramBotName},v3_key:function(){return window.appConfig.recaptcha.v3_sitekey},v2_key:function(){return window.appConfig.recaptcha.v2_sitekey},enableTelegramLogin:function(){return window.appConfig.enableTelegramLogin}},watch:{doing:function(t){var e=this;t?this.timeout=setTimeout((function(){e.loginIssue=!0}),5e3):clearTimeout(this.timeout)},useCaptcha:function(t){t&&(this.doing=!1)}}},r=o,u=a("2877"),p=a("eebe"),l=a.n(p),h=a("9989"),g=a("0378"),d=a("27f9"),f=a("7cbe"),m=a("54e1"),v=a("9c40"),w=Object(u["a"])(r,n,c,!1,null,null,null);e["default"]=w.exports;l()(w,"components",{QPage:h["a"],QForm:g["a"],QInput:d["a"],QPopupProxy:f["a"],QBanner:m["a"],QBtn:v["a"]})}}]);